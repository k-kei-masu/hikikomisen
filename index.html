<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>電線許容電流 判定システム</title>
<style>
  /* ------------ 全体レイアウト・レスポンシブ対応 ------------ */
  body {
    font-family: sans-serif;
    margin: 0; padding: 0;
    background: #f5f5f5;
  }
  header {
    background: #333;
    color: #fff;
    padding: 0.5em;
    text-align: center;
  }
  main {
    padding: 1em;
    max-width: 600px;
    margin: 0 auto;
    background: #fff;
    border-radius: 8px;
  }
  h1 {
    font-size: 1.2em;
    margin: 0.4em 0;
  }
  label {
    display: inline-block;
    margin-right: 0.5em;
  }
  select, input[type="number"], input[type="range"], input[type="text"] {
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 1em;
    padding: 0.4em;
    font-size: 1em;
  }
  .hidden {
    display: none;
  }
  .btn {
    display: inline-block;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 0.6em 1.2em;
    font-size: 1em;
    cursor: pointer;
  }
  .btn:hover {
    background: #0056b3;
  }
  .result {
    margin-top: 1em;
    padding: 1em;
    background: #eef;
    border-radius: 4px;
  }
  hr {
    margin: 1.5em 0;
  }
  footer {
    text-align: center;
    font-size: 0.8em;
    color: #666;
    margin: 1em 0;
  }
</style>
</head>
<body>

<header>
  <h1>電線許容電流 判定システム</h1>
</header>

<main>

  <!-- 相線の選択 -->
  <label for="phase">相線を選択：</label>
  <select id="phase">
    <option value="単三">単三</option>
    <option value="三相">三相</option>
    <option value="単二100V">単二100V</option>
  </select>

  <!-- ▼▼▼ [A] 単三 用 UI ▼▼▼ -->
  <div id="single-three-wire-section">
    <!-- 深夜負荷の配線状態 (単三のみ) -->
    <div id="night-load-section">
      <label for="nightLoad">深夜負荷配線状態：</label>
      <select id="nightLoad">
        <option value="なし">なし</option>
        <option value="一次側">一次側</option>
        <option value="二次側">二次側</option>
      </select>
    </div>

    <!-- 契約形態 (単三のみ) -->
    <div id="contract-section">
      <label for="contractType">契約形態：</label>
      <select id="contractType">
        <option value="ACL">ACL</option>
        <option value="主開閉器">主開閉器</option>
      </select>
    </div>

    <hr>

    <!-- ACL電流値（単三 & ACL時だけ表示）-->
    <div id="acl-section" class="hidden">
      <label for="aclValue">ACL電流値[A]：</label>
      <select id="aclValue">
        <option value="10">10A</option>
        <option value="15">15A</option>
        <option value="20">20A</option>
        <option value="30">30A</option>
        <option value="40">40A</option>
        <option value="50">50A</option>
        <option value="60">60A</option>
      </select>
    </div>

    <!-- 主開閉器容量（単三 & 主開閉器時だけ表示） -->
    <div id="mainCB-section" class="hidden">
      <label for="mainCB">主開閉器容量[kVA]：</label>
      <input id="mainCB" type="number" step="0.1" min="0" placeholder="例：5.0">
    </div>

    <!-- 深夜負荷容量（単三 & 深夜負荷一次側時に入力必要）-->
    <div id="nightLoadCap-section" class="hidden">
      <label for="nightLoadCap">深夜負荷容量[kVA]：</label>
      <input id="nightLoadCap" type="number" step="0.1" min="0" placeholder="例：2.0">
    </div>
  </div>
  <!-- ▲▲▲ 単三 用 UI 終了 ▲▲▲ -->

  <!-- ▼▼▼ [B] 三相 用 UI ▼▼▼ -->
  <div id="three-phase-section" class="hidden">
    <hr>
    <label for="threePhaseKW">負荷容量[kW]：</label>
    <input id="threePhaseKW" type="number" step="0.1" min="0" placeholder="例：10.0">

    <label>力率[%]：<span id="pf-label">85</span>%</label>
    <input id="powerFactor" type="range" min="0" max="100" step="1" value="85">
  </div>
  <!-- ▲▲▲ 三相 用 UI 終了 ▲▲▲ -->

  <!-- ▼▼▼ [C] 単二100V 用 UI ▼▼▼ -->
  <div id="two-wire-100v-section" class="hidden">
    <hr>
    <!-- 1. 電流値またはACL電流値(A) -->
    <div>
      <label for="twoWireCurrSelect">電流値(A) - 選択：</label>
      <select id="twoWireCurrSelect">
        <option value="5">5A</option>
        <option value="10">10A</option>
        <option value="15">15A</option>
        <option value="20">20A</option>
        <option value="30">30A</option>
      </select>
    </div>
    <div>
      <label for="twoWireCurrInput">電流値(A) - 自由入力：</label>
      <input id="twoWireCurrInput" type="number" step="1" min="0" placeholder="自由入力">
    </div>

    <!-- 2. 変圧器から引込柱の低圧線径間数 -->
    <label for="lineSpanSelect">線径間数：</label>
    <select id="lineSpanSelect">
      <option value="1径間以内">1径間以内</option>
      <option value="1径間超過">1径間超過</option>
    </select>

    <!-- 3. 引込線亘長 (選択肢は線径間数で分岐) -->
    <div>
      <label for="lengthRangeSelect">引込線亘長：</label>
      <select id="lengthRangeSelect">
        <!-- デフォルトは 1径間以内 が選択された状態に合わせ、 [30M以下 / 30M超過] を初期表示 -->
        <option value="30M以下">30M以下</option>
        <option value="30M超過">30M超過</option>
      </select>
    </div>
  </div>
  <!-- ▲▲▲ 単二100V 用 UI 終了 ▲▲▲ -->

  <hr>

  <!-- 亘長 (既存システム) -->
  <!--
    ※ 単二100Vでは別の「引込線亘長」選択肢を使うため、
       ここ（lengthInput）は 単三/三相用のみ活かす想定
  -->
  <div id="wireLength-section">
    <label for="length">電線亘長[m] (1～60)：</label>
    <input id="length" type="number" step="1" min="1" max="60" placeholder="1 ～ 60の範囲" />
  </div>

  <button class="btn" id="calcBtn">判定</button>

  <!-- 結果表示 -->
  <div class="result" id="resultArea" style="display: none;">
    <p id="calcResult"></p>
  </div>

</main>

<footer>
  <p>© 2023 電線許容電流 判定システム</p>
</footer>

<script>
/* ------------------------------------------------------------
   A. 既存の 三相/単三 用 許容電流データ (1m～60m)
   ------------------------------------------------------------ */
const wireData = {
  "2.6": [
    34,34,34,34,34,34,34,34,34,34,34,34,33,30,28,26,25,23,22,22,20,19,18,17,17,16,15,15,14,14,13,13,13,12,12,11,11,11,11,11,10,10,10,9,9,9,9,9,9,9,8,8,8,7,7,7,7,7,7,7
  ],
  "3.2": [
    44,44,44,44,44,44,44,44,44,44,44,44,44,44,43,40,38,36,34,33,31,29,28,27,26,25,24,23,22,22,21,20,19,19,18,18,17,17,16,16,15,15,15,14,14,14,13,13,13,13,12,12,12,12,11,11,11,11,11,10
  ],
  "14": [
    62,62,62,62,62,62,62,62,62,62,62,62,62,62,62,62,62,61,58,55,52,50,47,45,44,42,40,39,38,37,35,34,33,32,31,30,29,29,28,28,26,26,25,25,24,23,23,22,22,22,21,21,20,20,20,19,19,19,18,18
  ],
  "22": [
    80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,78,75,72,69,66,64,62,60,58,56,54,53,51,50,48,47,46,45,43,42,41,40,40,39,38,37,36,36,35,34,34,33,32,32,31,31,30,30
  ],
  "38": [
    113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,112,108,105,102,98,95,92,89,87,84,82,80,78,76,74,72,70,69,67,66,64,63,62,61,59,58,57,56,55,54,53,52,51,50,50,50,50,50,50,50,50,50,50
  ],
  "60": [
    152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,148,144,140,136,132,128,125,123,119,116,113,111,108,106,104,102,100,98,96,94,92,90,89,87,85,84,83,81
  ],
  "100": [
    209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,209,206,201,196,191,187,183,179,175,171,168,165,161,158,155,152,149,147,144,142,139,137
  ]
};

/* ------------------------------------------------------------
   B. 単二100V用のデータ表
      （「変圧器から引込柱の低圧線径間数」「引込線亘長」別・許容限度(A)）
   ------------------------------------------------------------ */
const table2w100V = [
  // 1径間以内 / 30M以下
  { wireSize: "2.0mm", lineSpan: "1径間以内", currentLimit: 20, lengthRange: "30M以下" },
  { wireSize: "2.6mm", lineSpan: "1径間以内", currentLimit: 30, lengthRange: "30M以下" },
  { wireSize: "3.2mm", lineSpan: "1径間以内", currentLimit: 50, lengthRange: "30M以下" },
  { wireSize: "14SQ",  lineSpan: "1径間以内", currentLimit: 75, lengthRange: "30M以下" },
  { wireSize: "22SQ",  lineSpan: "1径間以内", currentLimit:120, lengthRange: "30M以下" },
  { wireSize: "38SQ",  lineSpan: "1径間以内", currentLimit:220, lengthRange: "30M以下" },

  // 1径間以内 / 30M超過
  { wireSize: "2.6mm", lineSpan: "1径間以内", currentLimit: 20, lengthRange: "30M超過" },
  { wireSize: "3.2mm", lineSpan: "1径間以内", currentLimit: 30, lengthRange: "30M超過" },
  { wireSize: "14SQ",  lineSpan: "1径間以内", currentLimit: 50, lengthRange: "30M超過" },
  { wireSize: "22SQ",  lineSpan: "1径間以内", currentLimit: 80, lengthRange: "30M超過" },
  { wireSize: "38SQ",  lineSpan: "1径間以内", currentLimit:150, lengthRange: "30M超過" },

  // 1径間超過 / 15M以下
  { wireSize: "2.0mm", lineSpan: "1径間超過", currentLimit: 20, lengthRange: "15M以下" },
  { wireSize: "2.6mm", lineSpan: "1径間超過", currentLimit: 30, lengthRange: "15M以下" },
  { wireSize: "3.2mm", lineSpan: "1径間超過", currentLimit: 50, lengthRange: "15M以下" },
  { wireSize: "14SQ",  lineSpan: "1径間超過", currentLimit: 75, lengthRange: "15M以下" },
  { wireSize: "22SQ",  lineSpan: "1径間超過", currentLimit: 80, lengthRange: "15M以下" },
  { wireSize: "38SQ",  lineSpan: "1径間超過", currentLimit:150, lengthRange: "15M以下" },

  // 1径間超過 / 15M超過30M以下
  { wireSize: "2.0mm", lineSpan: "1径間超過", currentLimit: 10, lengthRange: "15M超過30M以下" },
  { wireSize: "2.6mm", lineSpan: "1径間超過", currentLimit: 20, lengthRange: "15M超過30M以下" },
  { wireSize: "3.2mm", lineSpan: "1径間超過", currentLimit: 30, lengthRange: "15M超過30M以下" },
  { wireSize: "14SQ",  lineSpan: "1径間超過", currentLimit: 50, lengthRange: "15M超過30M以下" },
  { wireSize: "22SQ",  lineSpan: "1径間超過", currentLimit: 80, lengthRange: "15M超過30M以下" },
  { wireSize: "38SQ",  lineSpan: "1径間超過", currentLimit:150, lengthRange: "15M超過30M以下" },

  // 1径間超過 / 30M超過
  { wireSize: "2.6mm", lineSpan: "1径間超過", currentLimit: 10, lengthRange: "30M超過" },
  { wireSize: "3.2mm", lineSpan: "1径間超過", currentLimit: 20, lengthRange: "30M超過" },
  { wireSize: "14SQ",  lineSpan: "1径間超過", currentLimit: 30, lengthRange: "30M超過" },
  { wireSize: "22SQ",  lineSpan: "1径間超過", currentLimit: 50, lengthRange: "30M超過" },
  { wireSize: "38SQ",  lineSpan: "1径間超過", currentLimit: 90, lengthRange: "30M超過" }
];

/* ------------------------------------------------------------
   C. DOM要素の参照
   ------------------------------------------------------------ */
/* --- 共通 --- */
const phase = document.getElementById("phase");
const calcBtn = document.getElementById("calcBtn");
const resultArea = document.getElementById("resultArea");
const calcResult = document.getElementById("calcResult");

/* --- 単三用要素 --- */
const singleThreeWireSection = document.getElementById("single-three-wire-section");
const nightLoad  = document.getElementById("nightLoad");
const contract   = document.getElementById("contractType");
const aclSection = document.getElementById("acl-section");
const mainCBSection = document.getElementById("mainCB-section");
const nightLoadCapSection = document.getElementById("nightLoadCap-section");

const aclValue     = document.getElementById("aclValue");
const mainCB       = document.getElementById("mainCB");
const nightLoadCap = document.getElementById("nightLoadCap");

/* --- 三相用要素 --- */
const threePhaseSection  = document.getElementById("three-phase-section");
const threePhaseKW = document.getElementById("threePhaseKW");
const powerFactor  = document.getElementById("powerFactor");
const pfLabel      = document.getElementById("pf-label");

/* --- 単二100V用要素 --- */
const twoWireSection = document.getElementById("two-wire-100v-section");
const twoWireCurrSelect = document.getElementById("twoWireCurrSelect");
const twoWireCurrInput  = document.getElementById("twoWireCurrInput");
const lineSpanSelect    = document.getElementById("lineSpanSelect");
const lengthRangeSelect = document.getElementById("lengthRangeSelect");

/* --- 既存システムの亘長(1～60m) --- */
const wireLengthSection = document.getElementById("wireLength-section");
const lengthInput  = document.getElementById("length");

/* ------------------------------------------------------------
   D. イベント設定
   ------------------------------------------------------------ */
// 力率のスライダー変更時
powerFactor.addEventListener("input", () => {
  pfLabel.textContent = powerFactor.value;
});

// 相線や契約形態の変更時に、表示フォームを動的に切り替え
function updateFormVisibility() {
  // 初期に全部隠す
  singleThreeWireSection.classList.add("hidden");
  threePhaseSection.classList.add("hidden");
  twoWireSection.classList.add("hidden");
  wireLengthSection.classList.add("hidden");

  // 単三向けUIを非表示にするかどうか
  if (phase.value === "単三") {
    singleThreeWireSection.classList.remove("hidden");
    wireLengthSection.classList.remove("hidden");

    // ACL or 主開閉器
    if (contract.value === "ACL") {
      aclSection.classList.remove("hidden");
      mainCBSection.classList.add("hidden");
    } else {
      aclSection.classList.add("hidden");
      mainCBSection.classList.remove("hidden");
    }
    // 深夜負荷配線状態
    if (nightLoad.value === "一次側") {
      nightLoadCapSection.classList.remove("hidden");
    } else {
      nightLoadCapSection.classList.add("hidden");
    }

  } else if (phase.value === "三相") {
    threePhaseSection.classList.remove("hidden");
    wireLengthSection.classList.remove("hidden");

  } else if (phase.value === "単二100V") {
    // 単二100V UI表示
    twoWireSection.classList.remove("hidden");
  }
}
phase.addEventListener("change", updateFormVisibility);
contract.addEventListener("change", updateFormVisibility);
nightLoad.addEventListener("change", updateFormVisibility);
lineSpanSelect.addEventListener("change", () => {
  // 「1径間以内」なら => lengthRangeSelectを [30M以下, 30M超過]
  // 「1径間超過」なら => lengthRangeSelectを [15M以下, 15M超過30M以下, 30M超過]
  if (lineSpanSelect.value === "1径間以内") {
    lengthRangeSelect.innerHTML = `
      <option value="30M以下">30M以下</option>
      <option value="30M超過">30M超過</option>
    `;
  } else {
    lengthRangeSelect.innerHTML = `
      <option value="15M以下">15M以下</option>
      <option value="15M超過30M以下">15M超過30M以下</option>
      <option value="30M超過">30M超過</option>
    `;
  }
});

/* 初期状態を反映 */
updateFormVisibility();

/* ------------------------------------------------------------
   E. 三相/単三 用の電流値計算 (公式A～E)
   ------------------------------------------------------------ */
function calculateCurrentForThreePhaseOrSingle() {
  let current = 0;

  if (phase.value === "三相") {
    // 公式E
    // 電流[A] = (負荷容量[kW] * 1000) / (1.73 * 200 * (力率[%]*0.01))
    const kw  = parseFloat(threePhaseKW.value) || 0;
    const pf  = parseFloat(powerFactor.value) * 0.01;
    if (pf === 0) return 0;
    current = (kw * 1000) / (1.73 * 200 * pf);
  } else {
    // 単三 (公式A～D)
    const nl = nightLoad.value;      // 深夜負荷
    const ct = contract.value;       // 契約形態
    const acl = parseFloat(aclValue.value) || 0;
    const mCB = parseFloat(mainCB.value) || 0;
    const nlCap = parseFloat(nightLoadCap.value) || 0;

    if (nl === "なし" || nl === "二次側") {
      if (ct === "ACL") {
        // 公式A: current = ACL * 0.6
        current = acl * 0.6;
      } else {
        // 公式B: current = 主開閉器容量[kVA] * 5
        current = mCB * 5;
      }
    } else {
      // 深夜負荷 = 一次側
      if (ct === "ACL") {
        // 公式C: current = (ACL*0.6) + (深夜負荷*5)
        current = (acl * 0.6) + (nlCap * 5);
      } else {
        // 公式D: current = (主開閉器容量*5) + (深夜負荷*5)
        current = (mCB * 5) + (nlCap * 5);
      }
    }
  }
  return current;
}

/* ------------------------------------------------------------
   F. 三相/単三 用の電線選定 (既存 wireData)
   ------------------------------------------------------------ */
function findSuitableWire(requiredA, lengthM) {
  // lengthM は1～60の想定
  if (lengthM < 1 || lengthM > 60) return null;

  // wireDataの各サイズを小さい順に見て、許容電流 >= requiredA となる最初のサイズを返す
  const sizes = Object.keys(wireData).map(Number).sort((a, b) => a - b);
  for (let i=0; i<sizes.length; i++) {
    let sizeKey = sizes[i].toString();
    let allowableA = wireData[sizeKey][lengthM - 1]; // 0-index
    if (allowableA >= requiredA) {
      return sizeKey;
    }
  }
  return null;
}

/* ------------------------------------------------------------
   G. 単二100V 用の電線選定ロジック
   ------------------------------------------------------------ */
function findWireForTwoWire100V(requestedA, lineSpan, lengthRange) {
  // 1) 対象となる行だけ抽出
  const subset = table2w100V.filter(row =>
    row.lineSpan === lineSpan && row.lengthRange === lengthRange
  );
  if (subset.length === 0) return null;

  // 2) wireSizeごとの優先順位付け（最小サイズ → 大サイズ）
  const wireOrder = {
    "2.0mm": 1,
    "2.6mm": 2,
    "3.2mm": 3,
    "14SQ": 4,
    "22SQ": 5,
    "38SQ": 6
  };

  // 3) wireOrder に基づいて小さい順にソート
  subset.sort((a, b) => (wireOrder[a.wireSize] || 999) - (wireOrder[b.wireSize] || 999));

  // 4) currentLimit >= requestedA を満たす最初のサイズを返す
  for (const row of subset) {
    if (row.currentLimit >= requestedA) {
      return row.wireSize;
    }
  }
  return null;
}

/* ------------------------------------------------------------
   H. 「判定ボタン」クリック時のメイン処理
   ------------------------------------------------------------ */
calcBtn.addEventListener("click", () => {
  let msg = "";
  resultArea.style.display = "block";

  if (phase.value === "三相" || phase.value === "単三") {
    // ▼ 三相 or 単三の場合 (既存ロジック) ▼
    const requiredA = calculateCurrentForThreePhaseOrSingle();

    // 入力されている亘長(1～60)を取得
    const dist = parseInt(lengthInput.value, 10);
    if (!dist || dist < 1 || dist > 60) {
      alert("亘長(1～60m)を正しく入力してください。");
      return;
    }

    msg += `計算された電流値: <strong>${requiredA.toFixed(1)}A</strong><br>`;
    // 電線選定
    const wireSize = findSuitableWire(requiredA, dist);
    if (wireSize) {
      msg += `亘長 ${dist}m の場合、<strong>${wireSize}sq</strong> 電線が最小で条件を満たします。`;
    } else {
      msg += `<span style="color:red;">条件を満たす電線が見つかりませんでした。</span>`;
    }

  } else {
    // ▼ 単二100Vの場合 ▼
    // 1) 入力された電流値[A]を確定
    const selVal = parseFloat(twoWireCurrSelect.value) || 0;
    const freeVal = parseFloat(twoWireCurrInput.value) || 0;
    // 「選択式」と「自由入力」で大きい方を採用する or どちらか優先？
    // → ここでは「自由入力があればそれを優先」, 無入力なら選択値を使う、とします
    let requestedA = freeVal > 0 ? freeVal : selVal;

    // 2) 線径間数・亘長区分を取得
    const lineSpan = lineSpanSelect.value;         // 1径間以内 or 1径間超過
    const lenRange = lengthRangeSelect.value;      // [30M以下, 30M超過] / [15M以下, 15M超過30M以下, 30M超過]

    msg += `契約電流(推定): <strong>${requestedA}A</strong><br>`;
    msg += `線径間数: ${lineSpan}, 亘長: ${lenRange}<br>`;

    // 3) 電線選定
    const wireSize = findWireForTwoWire100V(requestedA, lineSpan, lenRange);
    if (wireSize) {
      msg += `⇒ 最小の電線サイズは <strong>${wireSize}</strong> です。`;
    } else {
      msg += `<span style="color:red;">条件を満たす電線サイズが見つかりませんでした。</span>`;
    }
  }

  calcResult.innerHTML = msg;
});
</script>

</body>
</html>
